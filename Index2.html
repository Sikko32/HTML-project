<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>자리 배치 랜덤 배정기</title>
  <!-- Tailwind / Bootstrap / SweetAlert2 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* 약간의 추가 스타일 (Tailwind로 대부분 처리) */
    .seat{transition:transform .08s ease, box-shadow .2s ease, background .2s ease}
    .seat:active{transform:translateY(1px)}
    .seat.drag-over{outline:2px dashed rgba(255,255,255,.4); outline-offset:2px}
    .grid-wrap{container-type:inline-size}
    @container (min-width: 640px){ .panel{grid-template-columns: 1fr auto} }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-6">
  <main class="bg-gray-800/80 rounded-2xl shadow-2xl p-6 w-full max-w-5xl grid gap-5 grid-wrap">
    <header class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">자리 배치 랜덤 배정기</h1>
        <p class="text-gray-400 text-sm">1번부터 30번까지를 좌석에 무작위 배치합니다. (드래그로 자리 교환 가능)</p>
      </div>
      <div class="hidden sm:flex items-center gap-2 text-gray-400 text-xs">
        <span class="badge text-bg-info">Tailwind</span>
        <span class="badge text-bg-primary">Bootstrap</span>
        <span class="badge text-bg-success">SweetAlert2</span>
      </div>
    </header>

    <section class="panel grid gap-4">
      <div class="grid gap-4">
        <div class="grid sm:grid-cols-3 gap-3">
          <div class="form-floating">
            <input type="number" id="totalInput" class="form-control bg-gray-700 text-white border-0" value="30" min="1" max="60">
            <label for="totalInput">인원 수 (기본 30)</label>
          </div>
          <div class="form-floating">
            <input type="number" id="colsInput" class="form-control bg-gray-700 text-white border-0" value="6" min="2" max="12">
            <label for="colsInput">열(가로 칸 수)</label>
          </div>
          <div class="form-floating">
            <select id="orderInput" class="form-select bg-gray-700 text-white border-0">
              <option value="row" selected>왼→오, 위→아래</option>
              <option value="col">위→아래, 왼→오</option>
            </select>
            <label for="orderInput">배치 순서</label>
          </div>
        </div>

        <div class="flex flex-wrap gap-2">
          <button id="randBtn" class="btn btn-primary">랜덤 배치</button>
          <button id="swapResetBtn" class="btn btn-outline-light">교환 초기화</button>
          <button id="copyBtn" class="btn btn-info">CSV 복사</button>
          <button id="resetBtn" class="btn btn-danger">전체 초기화</button>
        </div>

        <div id="grid" class="grid gap-3"></div>
      </div>

      <aside class="bg-gray-900/50 rounded-xl p-4 h-fit">
        <h2 class="text-lg font-semibold mb-2">배치 기록</h2>
        <div id="history" class="space-y-2 text-sm"></div>
      </aside>
    </section>
  </main>

  <script>
    // —— 상태 ——
    const gridEl = document.getElementById('grid');
    const historyEl = document.getElementById('history');
    const totalInput = document.getElementById('totalInput');
    const colsInput = document.getElementById('colsInput');
    const orderInput = document.getElementById('orderInput');

    let seats = []; // 좌석 순서에 배정된 번호들
    let dragIndex = null; // 드래그 시작 인덱스

    // —— 유틸 ——
    const range = (n, start = 1) => Array.from({length: n}, (_, i) => i + start);
    function shuffle(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function calcRows(total, cols){
      return Math.ceil(total / cols);
    }

    // —— 그리드 렌더 ——
    function renderGrid(){
      const total = clampNum(parseInt(totalInput.value)||30, 1, 60);
      const cols = clampNum(parseInt(colsInput.value)||6, 2, 12);
      const rows = calcRows(total, cols);
      gridEl.style.gridTemplateColumns = `repeat(${cols}, minmax(64px, 1fr))`;

      // 좌석 칸 수에 맞춰 seats 길이 보정
      if(seats.length !== total){
        // 현재 배치를 가능한 한 유지하면서 보정
        const base = seats.filter(n=>n!=null).slice(0, total);
        const needed = total - base.length;
        const pool = range(total).filter(n=>!base.includes(n));
        seats = base.concat(pool.slice(0, needed));
      }

      gridEl.innerHTML = '';
      for(let i=0;i<rows*cols;i++){
        const cell = document.createElement('div');
        cell.className = 'aspect-square seat rounded-2xl bg-gray-700/70 border border-gray-600 shadow flex items-center justify-center relative select-none';
        cell.dataset.index = i;

        if(i < total){
          const n = seats[i];
          cell.draggable = true;
          cell.innerHTML = `
            <div class="text-center">
              <div class="text-2xl font-extrabold">${n}</div>
              <div class="text-[10px] text-gray-300">seat ${i+1}</div>
            </div>`;
        } else {
          cell.classList.add('bg-transparent','border-dashed','border-gray-500/40');
        }

        // Drag & Drop
        cell.addEventListener('dragstart', (e)=>{
          dragIndex = i;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', String(i));
        });
        cell.addEventListener('dragenter', ()=> cell.classList.add('drag-over'));
        cell.addEventListener('dragleave', ()=> cell.classList.remove('drag-over'));
        cell.addEventListener('dragover', (e)=> e.preventDefault());
        cell.addEventListener('drop', (e)=>{
          e.preventDefault();
          cell.classList.remove('drag-over');
          const from = dragIndex;
          const to = i;
          if(from===null || from===to) return;
          swapSeats(from, to);
        });

        gridEl.appendChild(cell);
      }
    }

    function clampNum(v, min, max){ return Math.min(max, Math.max(min, v)); }

    function swapSeats(a, b){
      const total = clampNum(parseInt(totalInput.value)||30, 1, 60);
      if(a>=total || b>=total) return;
      [seats[a], seats[b]] = [seats[b], seats[a]];
      renderGrid();
    }

    // —— 동작 ——
    function randomize(){
      const total = clampNum(parseInt(totalInput.value)||30, 1, 60);
      const cols = clampNum(parseInt(colsInput.value)||6, 2, 12);
      const order = orderInput.value; // 'row' | 'col'
      seats = shuffle(range(total));

      // 시각적 애니메이션 느낌을 위해 한번 더 섞은 후 적용
      renderGrid();
      Swal.fire({
        icon: 'success',
        title: '랜덤 배치 완료!',
        html: `<div class='text-xs text-gray-600'>총 <b>${total}</b>명, 열 <b>${cols}</b>, 순서 <b>${order==='row'?'가로 우선':'세로 우선'}</b></div>`,
        confirmButtonText: '확인',
        confirmButtonColor: '#2563eb',
        backdrop: true,
        showClass: {popup: 'animate__animated animate__fadeInDown'},
        hideClass: {popup: 'animate__animated animate__fadeOutUp'}
      });
      pushHistory();
    }

    function pushHistory(){
      const stamp = new Date().toLocaleString();
      const row = document.createElement('div');
      row.className = 'd-flex justify-content-between align-items-center gap-2 bg-gray-700 rounded p-2';
      const preview = seats.map(n=>`<span class='badge text-bg-secondary me-1'>${n}</span>`).join('');
      row.innerHTML = `<div class='flex-1'>${preview}</div><div class='text-gray-300 text-xs'>${stamp}</div>`;
      historyEl.prepend(row);
    }

    function copyCSV(){
      const cols = clampNum(parseInt(colsInput.value)||6, 2, 12);
      const total = seats.length;
      // 행 기준 CSV
      const rows = [];
      for(let i=0;i<total;i+=cols){
        rows.push(seats.slice(i, i+cols).join(','));
      }
      const text = rows.join('\n');
      navigator.clipboard.writeText(text).then(()=>{
        Swal.fire({icon:'info', title:'CSV로 복사됨', text:'엑셀에 붙여넣기 하세요.'});
      });
    }

    function resetAll(){
      Swal.fire({
        title: '전체 초기화',
        text: '배치와 기록을 모두 지울까요?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '초기화',
        cancelButtonText: '취소',
        confirmButtonColor: '#ef4444'
      }).then((r)=>{
        if(r.isConfirmed){
          seats = [];
          historyEl.innerHTML = '';
          totalInput.value = 30; colsInput.value = 6; orderInput.value = 'row';
          seats = range(30); // 1~30 기본
          renderGrid();
          Swal.fire({icon:'success', title:'초기화 완료'});
        }
      });
    }

    function resetSwaps(){
      // 현재 구성의 숫자만 오름차순으로 재정렬 (1..N)
      const total = clampNum(parseInt(totalInput.value)||30, 1, 60);
      seats = range(total);
      renderGrid();
      Swal.fire({icon:'success', title:'교환 초기화', text:'1부터 차례대로 재배치했습니다.'});
    }

    // —— 이벤트 ——
    document.getElementById('randBtn').addEventListener('click', randomize);
    document.getElementById('copyBtn').addEventListener('click', copyCSV);
    document.getElementById('resetBtn').addEventListener('click', resetAll);
    document.getElementById('swapResetBtn').addEventListener('click', resetSwaps);

    totalInput.addEventListener('change', ()=>{ seats = range(clampNum(parseInt(totalInput.value)||30,1,60)); renderGrid(); });
    colsInput.addEventListener('change', renderGrid);
    orderInput.addEventListener('change', renderGrid);

    // —— 초기화 ——
    seats = range(30);
    renderGrid();
  </script>
</body>
</html>
